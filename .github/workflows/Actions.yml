name: OpenWrt Custom Firmware

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支（如 main, openwrt-24.10）'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构（如 airoha, x86_64）'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号（如 an7581）'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCI 应用（逗号分隔，如 luci-app-adblock）'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule'
        type: string
      include_packages:
        description: '软件包（非 LuCI，逗号分隔）'
        required: false
        default: 'tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: '发布到 GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: '启用详细构建输出（V=s）'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: /tmp/ccache
  BUILD_LOG_DIR: build_logs

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
    
    steps:
    - name: 生成构建信息
      id: build_info
      run: |
        BUILD_DATE=$(date +%Y%m%d-%H%M%S)
        COMMIT_SHORT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
        echo "RELEASE_TAG=build-$BUILD_DATE" >> $GITHUB_ENV
        
        echo "构建信息:"
        echo "构建日期: $BUILD_DATE"
        echo "提交哈希: $COMMIT_SHORT"

    - name: 检出 OpenWrt 源代码
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: true

    - name: 安装构建依赖
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync unzip zlib1g-dev file wget make ccache ecj fastjar java-propose-classpath libxml-parser-perl libelf-dev autoconf automake libtool autopoint device-tree-compiler curl python3 python3-pip python3-dev pkg-config bc kmod ack antlr3 asciidoc bzip2 cmake cpio help2man intltool libc6-dev-i386 libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncursesw5-dev libreadline-dev libpython3-dev ninja-build patch python3-pyelftools qemu-utils scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl xmlto xxd

    - name: 配置构建缓存
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-
          ${{ runner.os }}-openwrt-

    - name: 设置 ccache
      run: ccache -M 5G

    - name: 初始化 feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成基础配置
      run: |
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y" > .config
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        make defconfig

    - name: 自定义软件包配置
      run: |
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            echo "CONFIG_PACKAGE_${app}=y" >> .config
          done
        fi
        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.include_packages }}"
          for pkg in "${PKGS[@]}"; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        make defconfig

    - name: 验证配置
      run: |
        echo "验证构建配置..."
        if ! grep -q "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y" .config; then
          echo "错误：目标架构配置验证失败"
          exit 1
        fi
        if ! grep -q "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y" .config; then
          echo "错误：设备型号配置验证失败"
          exit 1
        fi
        echo "配置验证通过"

    - name: 预下载软件包
      run: make download -j$(nproc)

    - name: 磁盘空间监控
      run: |
        echo "构建前磁盘空间:"
        df -h
        echo "当前目录大小:"
        du -sh .

    - name: 构建 OpenWrt 固件
      run: |
        mkdir -p $BUILD_LOG_DIR
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          make V=s -j$(nproc) 2>&1 | tee $BUILD_LOG_DIR/build.log
        else
          make -j$(nproc) 2>&1 | tee $BUILD_LOG_DIR/build.log
        fi

    - name: 收集构建产物信息
      if: success()
      run: |
        echo "构建产物列表:"
        find bin/targets/ -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.manifest" \) | while read file; do
          echo "产物: $file"
          ls -lh "$file"
        done
        
        # 生成构建摘要
        echo "## 构建摘要" > $BUILD_LOG_DIR/build_summary.md
        echo "- **构建日期**: ${{ env.BUILD_DATE }}" >> $BUILD_LOG_DIR/build_summary.md
        echo "- **源码提交**: ${{ env.COMMIT_SHORT }}" >> $BUILD_LOG_DIR/build_summary.md
        echo "- **目标架构**: ${{ github.event.inputs.target_arch }}" >> $BUILD_LOG_DIR/build_summary.md
        echo "- **设备型号**: ${{ github.event.inputs.device_model }}" >> $BUILD_LOG_DIR/build_summary.md
        echo "- **源码分支**: ${{ github.event.inputs.source_branch }}" >> $BUILD_LOG_DIR/build_summary.md
        echo "" >> $BUILD_LOG_DIR/build_summary.md
        echo "### 包含的软件包" >> $BUILD_LOG_DIR/build_summary.md
        echo "- LuCI应用: ${{ github.event.inputs.include_luci_apps }}" >> $BUILD_LOG_DIR/build_summary.md
        echo "- 软件包: ${{ github.event.inputs.include_packages }}" >> $BUILD_LOG_DIR/build_summary.md

    - name: 上传构建产物至 Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware-${{ env.BUILD_DATE }}
        path: bin/targets/
        retention-days: 7

    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ env.BUILD_DATE }}
        path: $BUILD_LOG_DIR/
        retention-days: 7

    - name: 创建 GitHub Release
      if: github.event.inputs.create_release == 'true' && success()
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ env.RELEASE_TAG }}
        name: OpenWrt Build ${{ env.BUILD_DATE }}
        body: |
          # OpenWrt 自定义构建

          ## 构建信息
          - **构建日期**: ${{ env.BUILD_DATE }}
          - **源码提交**: ${{ env.COMMIT_SHORT }}
          - **目标架构**: ${{ github.event.inputs.target_arch }}
          - **设备型号**: ${{ github.event.inputs.device_model }}
          - **源码分支**: ${{ github.event.inputs.source_branch }}

          ## 软件包配置
          - **LuCI应用**: ${{ github.event.inputs.include_luci_apps }}
          - **软件包**: ${{ github.event.inputs.include_packages }}

          ## 构建参数
          - **详细构建**: ${{ github.event.inputs.verbose_build }}
          - **Release标签**: ${{ env.RELEASE_TAG }}

          ---
          此版本由 GitHub Actions 自动构建生成。
        artifacts: "bin/targets/**/*,!bin/targets/**/*.log,!bin/targets/**/packages/**/*"
        draft: false
        prerelease: false
        allowUpdates: true
        replacesArtifacts: true
        artifactErrorsFailBuild: false

    - name: 构建失败诊断信息
      if: failure()
      run: |
        echo "构建失败诊断信息:"
        echo "当前目录内容:"
        ls -la
        echo "配置文件前50行:"
        head -50 .config 2>/dev/null || echo "未找到配置文件"
        echo "磁盘空间情况:"
        df -h
        echo "内存使用情况:"
        free -h
        echo "构建日志片段:"
        tail -100 $BUILD_LOG_DIR/build.log 2>/dev/null || echo "未找到构建日志"