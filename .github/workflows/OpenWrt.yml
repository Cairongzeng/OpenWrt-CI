name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支（如 main, openwrt-24.10）'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构（如 airoha, x86_64）'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号（如 an7581）'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCI 应用（逗号分隔，如 luci-app-adblock）'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule'
        type: string
      include_packages:
        description: '功能包列表（非 LuCI，逗号分隔）'
        required: false
        default: 'tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: '发布到 GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: '启用详细构建输出（V=s）'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: ~/.ccache
  BUILD_LOG_DIR: build_logs

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: 检出OpenWrt源代码
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive
        fetch-depth: 0

    - name: 验证源代码结构
      run: |
        echo "## 验证 OpenWrt 源代码结构"
        echo "工作目录: $(pwd)"
        
        # 检查关键文件
        REQUIRED_FILES=("scripts/feeds" "feeds.conf.default" "rules.mk" "Makefile")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file 存在"
            if [[ "$file" == *"feeds" ]]; then
              chmod +x "$file"
            fi
          else
            echo "❌ 错误: $file 不存在"
            exit 1
          fi
        done

    - name: 安装构建依赖
      run: |
        sudo apt-get update -q
        # OpenWrt 官方推荐的构建依赖
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget \
          make ccache

    - name: 配置构建缓存
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          dl
          build_dir
          staging_dir
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-
          ${{ runner.os }}-openwrt-

    - name: 设置ccache缓存
      run: |
        ccache -M 10G
        ccache -s

    - name: 初始化feeds
      run: |
        chmod +x scripts/feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成基础配置
      run: |
        set -e
        
        # 创建基础配置
        cat << EOF > .config
CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y
CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y
CONFIG_CCACHE=y
CONFIG_BUILD_LOG=y
EOF
        
        make defconfig

    - name: 自定义软件包配置
      run: |
        set -e
        
        # 添加LuCI应用
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra LUCI_APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${LUCI_APPS[@]}"; do
            echo "CONFIG_PACKAGE_${app}=y" >> .config
          done
        fi
        
        # 添加功能包
        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          IFS=',' read -ra PACKAGES <<< "${{ github.event.inputs.include_packages }}"
          for pkg in "${PACKAGES[@]}"; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        
        make defconfig

    - name: 预下载软件包
      run: |
        set -e
        make download -j$(nproc) || make download -j1

    - name: 构建OpenWrt固件
      run: |
        set -e
        mkdir -p $BUILD_LOG_DIR
        
        BUILD_OPTIONS=""
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          BUILD_OPTIONS="V=s"
        fi
        
        make -j$(nproc) $BUILD_OPTIONS 2>&1 | tee $BUILD_LOG_DIR/build.log || {
          echo "构建失败，最后100行日志:"
          tail -100 $BUILD_LOG_DIR/build.log
          exit 1
        }

    - name: 上传构建产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-binaries
        path: |
          bin/targets/**
        retention-days: 7

    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          $BUILD_LOG_DIR/
        retention-days: 7
