name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Ê∫êÁ†ÅÂàÜÊîØ'
        required: true
        default: 'main'
        type: string
      target_arch:
        description: 'ËÆæÂ§áÊû∂ÊûÑ'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: 'ËÆæÂ§áÂûãÂè∑'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCIÂ∫îÁî®ÔºàÈÄóÂè∑ÂàÜÈöîÔºâ'
        required: false
        default: 'luci-app-upnp,luci-app-firewall,luci-app-wireguard'
        type: string
      include_packages:
        description: 'Ëá™ÂÆö‰πâÂåÖÂàóË°®ÔºàÈùûLuCIÔºåÈÄóÂè∑ÂàÜÈöîÔºâ'
        required: false
        default: 'iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: 'ÂèëÂ∏ÉÂà∞GitHub Release'
        required: false
        default: true
        type: boolean
      verbose_build:
        description: 'ÂêØÁî®ËØ¶ÁªÜÊûÑÂª∫ËæìÂá∫'
        required: false
        default: false
        type: boolean
      custom_feeds:
        description: 'Ëá™ÂÆö‰πâfeeds URLÔºàÊØèË°å‰∏Ä‰∏™ÔºåÊ†ºÂºè: name>urlÔºâ'
        required: false
        default: ''
        type: string
      build_profile:
        description: 'ÊûÑÂª∫ÈÖçÁΩÆ'
        required: false
        default: 'standard'
        type: choice
        options:
          - minimal
          - standard
          - full
      kernel_modules:
        description: 'È¢ùÂ§ñÂÜÖÊ†∏Ê®°ÂùóÔºàÈÄóÂè∑ÂàÜÈöîÔºâ'
        required: false
        default: ''
        type: string
      include_chinese:
        description: 'ÂåÖÂê´‰∏≠ÊñáËØ≠Ë®ÄÊîØÊåÅ'
        required: false
        default: true
        type: boolean

env:
  # Ê≠£Á°ÆÂÆö‰πâÁéØÂ¢ÉÂèòÈáèÔºåÈÅøÂÖçÂêéÁª≠Ê≠•È™§ÂºïÁî®ÈóÆÈ¢ò
  TARGET_ARCH: ${{ github.event.inputs.target_arch }}
  DEVICE_MODEL: ${{ github.event.inputs.device_model }}
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 4G

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    
    steps:
    - name: Checkout Source Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: Get Repository Metadata
      id: repo_info
      run: |
        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "branch=$(git branch --show-current 2>/dev/null || echo 'detached')" >> $GITHUB_OUTPUT
        echo "tag=$(git describe --tags --abbrev=0 2>/dev/null || echo 'none')" >> $GITHUB_OUTPUT

    - name: Setup Build Environment
      run: |
        sudo apt-get update -q
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-venv \
          rsync \
          unzip \
          wget \
          zlib1g-dev \
          file \
          time \
          ccache \
          python3-dev \
          python3-wheel \
          subversion \
          libxml-parser-perl \
          libjson-perl \
          curl \
          jq \
          tree

    - name: Prepare Build Directories
      run: |
        mkdir -p "${{ env.CCACHE_DIR }}"
        mkdir -p dl build_dir staging_dir logs
        chmod -R 755 "${{ env.CCACHE_DIR }}"

    - name: Cache Build Artifacts
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          dl
          build_dir
          staging_dir
        key: openwrt-build-${{ runner.os }}-${{ github.event.inputs.source_branch }}-${{ env.TARGET_ARCH }}-${{ env.DEVICE_MODEL }}-${{ steps.repo_info.outputs.sha }}
        restore-keys: |
          openwrt-build-${{ runner.os }}-${{ github.event.inputs.source_branch }}-${{ env.TARGET_ARCH }}-${{ env.DEVICE_MODEL }}-
          openwrt-build-${{ runner.os }}-${{ github.event.inputs.source_branch }}-${{ env.TARGET_ARCH }}-
          openwrt-build-${{ runner.os }}-${{ github.event.inputs.source_branch }}-
          openwrt-build-${{ runner.os }}-

    - name: Setup Custom Package Feeds
      if: github.event.inputs.custom_feeds != ''
      run: |
        echo "üîß Setting up custom feeds..."
        echo "${{ github.event.inputs.custom_feeds }}" | while IFS= read -r line; do
          line_cleaned=$(echo "$line" | tr -d '\r' | sed 's/[^a-zA-Z0-9>._:-]//g')
          if [ -n "$line_cleaned" ] && [[ $line_cleaned == *">"* ]]; then
            feed_name=$(echo "$line_cleaned" | cut -d'>' -f1)
            feed_url=$(echo "$line_cleaned" | cut -d'>' -f2-)
            
            # ‰∏•Ê†ºÈ™åËØÅHTTPSÂçèËÆÆÂíåËØÅ‰π¶ÊúâÊïàÊÄß
            if [[ $feed_url =~ ^https:// ]] && [ -n "$feed_name" ]; then
              if curl -sI "$feed_url" | grep -q "HTTP/"; then
                echo "Adding feed: $feed_name > $feed_url"
                echo "$line_cleaned" >> feeds.conf.default
              else
                echo "‚ö†Ô∏è Skipping feed with invalid HTTPS certificate: $feed_url"
              fi
            else
              echo "‚ö†Ô∏è Skipping non-HTTPS feed: $feed_url"
            fi
          fi
        done

    - name: Update Package Feeds
      run: |
        echo "üîÑ Updating package feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Install Required Packages
      run: |
        set -e
        
        echo "üì¶ Installing core packages..."
        CORE_PACKAGES=("luci" "luci-base" "luci-compat")
        for pkg in "${CORE_PACKAGES[@]}"; do
          if ! ./scripts/feeds install "$pkg"; then
            echo "‚ùå Core package $pkg installation failed"
            exit 1
          fi
        done
        
        echo "üì¶ Installing optional packages..."
        OPTIONAL_PACKAGES=("luci-theme-bootstrap" "luci-theme-argon")
        for pkg in "${OPTIONAL_PACKAGES[@]}"; do
          ./scripts/feeds install "$pkg" || echo "‚ö†Ô∏è Optional package $pkg installation failed"
        done

        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          echo "üì¶ Installing LuCI applications..."
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            app_cleaned=$(echo "$app" | xargs | sed 's/[^a-zA-Z0-9_-]//g')
            if [ -n "$app_cleaned" ]; then
              ./scripts/feeds install "$app_cleaned" || echo "‚ö†Ô∏è LuCI app $app_cleaned installation failed"
            fi
          done
        fi

        if [ "${{ github.event.inputs.include_chinese }}" = "true" ]; then
          echo "üåê Installing Chinese language support..."
          ./scripts/feeds install luci-i18n-base-zh-cn || echo "‚ö†Ô∏è Chinese language pack installation failed"
        fi
        
        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          echo "üì¶ Installing custom packages..."
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.include_packages }}"
          for pkg in "${PKGS[@]}"; do
            pkg_cleaned=$(echo "$pkg" | xargs | sed 's/[^a-zA-Z0-9_-]//g')
            if [ -n "$pkg_cleaned" ]; then
              ./scripts/feeds install "$pkg_cleaned" || echo "‚ö†Ô∏è Custom package $pkg_cleaned installation failed"
            fi
          done
        fi

    - name: Generate Build Configuration
      run: |
        if ! command -v gettext > /dev/null 2>&1; then
          sudo apt-get install -y gettext
        fi
        
        # Áõ¥Êé•ÁîüÊàêÈÖçÁΩÆÊñá‰ª∂ÔºåÈÅøÂÖç‰ΩøÁî®Ê®°ÊùøÂíåsedÊõøÊç¢
        cat > .config << EOF
# Target configuration
CONFIG_TARGET_${{ env.TARGET_ARCH | tr '[:lower:]' '[:upper:]' | tr '.-' '_' }}=y
CONFIG_TARGET_${{ env.TARGET_ARCH | tr '[:lower:]' '[:upper:]' | tr '.-' '_' }}_${{ env.DEVICE_MODEL | tr '[:lower:]' '[:upper:]' | tr '.-' '_' }}=y

# Core packages
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-theme-argon=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_CCACHE=y

# Essential tools
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_wget=y
CONFIG_PACKAGE_htop=y
CONFIG_PACKAGE_nano=y
EOF

        # Âä®ÊÄÅÊ∑ªÂä†È¢ùÂ§ñÈÖçÁΩÆ
        if [ "${{ github.event.inputs.include_chinese }}" = "true" ]; then
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        fi

        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            app_cleaned=$(echo "$app" | xargs | sed 's/[^a-zA-Z0-9_-]//g')
            if [ -n "$app_cleaned" ]; then
              echo "CONFIG_PACKAGE_${app_cleaned}=y" >> .config
            fi
          done
        fi

        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.include_packages }}"
          for pkg in "${PKGS[@]}"; do
            pkg_cleaned=$(echo "$pkg" | xargs | sed 's/[^a-zA-Z0-9_-]//g')
            if [ -n "$pkg_cleaned" ]; then
              echo "CONFIG_PACKAGE_${pkg_cleaned}=y" >> .config
            fi
          done
        fi

        if [ -n "${{ github.event.inputs.kernel_modules }}" ]; then
          IFS=',' read -ra MODULES <<< "${{ github.event.inputs.kernel_modules }}"
          for module in "${MODULES[@]}"; do
            module_cleaned=$(echo "$module" | xargs | sed 's/[^a-zA-Z0-9_-]//g')
            if [ -n "$module_cleaned" ]; then
              echo "CONFIG_PACKAGE_kmod-${module_cleaned}=y" >> .config
            fi
          done
        fi

        if [ ! -s .config ]; then
          echo "‚ùå Configuration file is empty"
          exit 1
        fi
        
        if ! grep -q "CONFIG_TARGET_${{ env.TARGET_ARCH | tr '[:lower:]' '[:upper:]' | tr '.-' '_' }}=y" .config; then
          echo "‚ùå Target configuration generation failed"
          exit 1
        fi

        echo "‚úÖ Configuration generated successfully"
        make defconfig

    - name: Build Firmware
      id: build_firmware
      run: |
        set +e
        
        BUILD_START=$(date +%s)
        echo "üî® Starting firmware build..."
        
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          echo "üìù Verbose build enabled"
          make -j$(nproc) V=s
        else
          make -j$(nproc)
        fi
        
        BUILD_EXIT_CODE=$?
        BUILD_END=$(date +%s)
        BUILD_DURATION=$((BUILD_END - BUILD_START))
        
        echo "build_duration=$BUILD_DURATION" >> $GITHUB_OUTPUT
        echo "build_exit_code=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "build_status=success" >> $GITHUB_OUTPUT
          echo "‚úÖ Build completed successfully in ${BUILD_DURATION}s"
        else
          echo "build_status=failed" >> $GITHUB_OUTPUT
          echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE after ${BUILD_DURATION}s"
        fi
        
        exit $BUILD_EXIT_CODE

    - name: Monitor System Resources
      if: always()
      run: |
        echo "üìä Detailed System Resource Usage:"
        echo "--- Disk Space ---"
        df -h
        echo "--- Memory Usage ---"
        free -h
        echo "--- CPU Usage ---"
        top -bn1 | head -10
        echo "--- CCache Statistics ---"
        ccache -s 2>/dev/null || echo "CCache not available"

    - name: Verify Build Artifacts
      if: steps.build_firmware.outputs.build_status == 'success'
      run: |
        echo "üîç Verifying build artifacts..."
        
        if [ ! -d "bin/targets" ]; then
          echo "‚ùå Build output directory 'bin/targets' not found"
          exit 1
        fi
        
        FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.tar" \) -size +1M 2>/dev/null | head -10)
        
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "‚ùå No firmware files found"
          echo "Available files in bin/targets:"
          find bin/targets -type f | head -20
          exit 1
        fi
        
        echo "‚úÖ Found firmware files:"
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            size=$(du -h "$file" | cut -f1)
            checksum=$(sha256sum "$file" | cut -d' ' -f1 | head -c 16)
            echo "  üìÑ $(basename "$file") ($size) [sha256:$checksum...]"
          fi
        done <<< "$FIRMWARE_FILES"

    - name: Upload Build Artifacts
      if: steps.build_firmware.outputs.build_status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.TARGET_ARCH }}-${{ env.DEVICE_MODEL }}
        path: bin/targets/
        retention-days: 30
        compression-level: 0

    - name: Create GitHub Release
      if: github.event.inputs.create_release && steps.build_firmware.outputs.build_status == 'success'
      uses: ncipollo/release-action@v2
      with:
        tag: openwrt-${{ env.TARGET_ARCH }}-${{ env.DEVICE_MODEL }}-${{ github.run_number }}
        name: OpenWrt ${{ env.TARGET_ARCH }}/${{ env.DEVICE_MODEL }} Build ${{ github.run_number }}
        body: |
          # OpenWrt Firmware Build
          
          ## Build Information
          - **Architecture**: ${{ env.TARGET_ARCH }}
          - **Device Model**: ${{ env.DEVICE_MODEL }}
          - **Source Branch**: ${{ github.event.inputs.source_branch }}
          - **Build Duration**: ${{ steps.build_firmware.outputs.build_duration }} seconds
          - **Build Profile**: ${{ github.event.inputs.build_profile }}
          - **Chinese Support**: ${{ github.event.inputs.include_chinese }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Included Packages
          - **LuCI Applications**: ${{ github.event.inputs.include_luci_apps }}
          - **Custom Packages**: ${{ github.event.inputs.include_packages }}
          - **Kernel Modules**: ${{ github.event.inputs.kernel_modules }}
          
          ## Repository Information
          - **Commit**: ${{ steps.repo_info.outputs.sha }}
          - **Branch**: ${{ steps.repo_info.outputs.branch }}
          - **Tag**: ${{ steps.repo_info.outputs.tag }}
          
          > Automatically built by GitHub Actions
        artifacts: "bin/targets/**/*"
        draft: false
        prerelease: false
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Handle Build Failure
      if: steps.build_firmware.outputs.build_status == 'failed'
      run: |
        echo "‚ùå Build failed after ${{ steps.build_firmware.outputs.build_duration }} seconds"
        echo "Exit code: ${{ steps.build_firmware.outputs.build_exit_code }}"
        
        if [ -f "logs/build.log" ]; then
          echo "Last 50 lines of build log:"
          tail -50 logs/build.log
        elif [ -d "logs" ]; then
          echo "Available log files:"
          find logs -type f -name "*.log" | head -10
        fi
        
        echo "Remaining disk space:"
        df -h .
        
        echo "üí° Next steps:"
        echo "   - Check the build log above for errors"
        echo "   - Verify your device configuration"
        echo "   - Ensure all required packages are available"
        echo "   - Try building with verbose output enabled"
