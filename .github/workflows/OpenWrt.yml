name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch (e.g., main, openwrt-24.10)'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: 'Target architecture (e.g., airoha, x86_64)'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: 'Device model (e.g., an7581)'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCI apps (comma separated, e.g., luci-app-adblock)'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule'
        type: string
      include_packages:
        description: 'Additional packages (comma separated, non-LuCI)'
        required: false
        default: 'tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: 'Enable verbose build output (V=s)'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: /tmp/ccache
  BUILD_LOG_DIR: build_logs

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout OpenWrt source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: true

    - name: Validate source structure
      run: |
        echo "Validating OpenWrt source structure"
        
        REQUIRED_FILES=("scripts/feeds" "feeds.conf.default" "Makefile")
        for file in "${REQUIRED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
            [ "$file" = "scripts/feeds" ] && chmod +x "$file"
          else
            echo "❌ Error: $file missing"
            exit 1
          fi
        done

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget \
          make ccache ecj fastjar java-propose-classpath \
          libxml-parser-perl libelf-dev autoconf automake \
          libtool autopoint device-tree-compiler curl \
          python3 python3-pip python3-dev pkg-config bc kmod \
          ack antlr3 asciidoc bzip2 cmake cpio help2man intltool \
          libc6-dev-i386 libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncursesw5-dev \
          libreadline-dev libpython3-dev ninja-build patch \
          python3-pyelftools qemu-utils scons squashfs-tools \
          subversion swig texinfo uglifyjs upx-ucl xmlto xxd

    - name: Configure build cache
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-
          ${{ runner.os }}-openwrt-

    - name: Setup ccache
      run: |
        ccache -M 5G
        ccache -s

    - name: Initialize feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate base config
      run: |
        # Create base configuration
        {
          echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y"
          echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y"
          echo "CONFIG_CCACHE=y"
          echo "CONFIG_BUILD_LOG=y"
        } > .config
        make defconfig

    - name: Custom package configuration
      run: |
        # Add LuCI apps
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            echo "CONFIG_PACKAGE_${app}=y" >> .config
          done
        fi
        
        # Add additional packages
        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.include_packages }}"
          for pkg in "${PKGS[@]}"; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        
        make defconfig

    - name: Pre-download packages
      run: |
        make download -j$(nproc) || make download -j1

    - name: Build OpenWrt firmware
      run: |
        mkdir -p $BUILD_LOG_DIR
        
        # Set build options based on input
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          BUILD_OPTIONS="V=s"
        else
          BUILD_OPTIONS=""
        fi
        
        # Execute build with proper error handling
        if ! make -j$(nproc) $BUILD_OPTIONS 2>&1 | tee $BUILD_LOG_DIR/build.log; then
          echo "Build failed with exit code: $?"
          exit 1
        fi

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: bin/targets/
        retention-days: 7

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: $BUILD_LOG_DIR/
        retention-days: 7

    - name: Diagnostic info on failure
      if: failure()
      run: |
        echo "Build failure diagnostic info:"
        echo "Last 100 lines of build log:"
        tail -100 $BUILD_LOG_DIR/build.log 2>/dev/null || echo "No build log found"
        echo "Current directory contents:"
        ls -la
        echo "Config file contents (first 100 lines):"
        head -100 .config 2>/dev/null || echo "No config file found"