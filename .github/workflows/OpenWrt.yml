name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支（如 main, openwrt-24.10）'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构（如 airoha, x86_64）'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号（如 an7581）'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCI 应用（逗号分隔，如 luci-app-adblock）'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule'
        type: string
      include_packages:
        description: '功能包列表（非 LuCI，逗号分隔）'
        required: false
        default: 'tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: '发布到 GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: '启用详细构建输出（V=s）'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      TARGET_ARCH: ${{ github.event.inputs.target_arch }}
      DEVICE_MODEL: ${{ github.event.inputs.device_model }}

    steps:
    - name: 检出OpenWrt源代码
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: 获取仓库元数据
      id: repo_info
      run: |
        echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "branch=$(git branch --show-current || echo 'detached')" >> $GITHUB_OUTPUT
        echo "tag=$(git describe --tags --abbrev=0 || echo 'none')" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

    - name: 安装构建依赖
      run: |
        sudo apt-get update -q
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk \
          gettext git libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 unzip wget \
          python3-distutils python3-setuptools rsync subversion \
          swig time xsltproc zlib1g-dev clang flex bison gcc-multilib \
          python3-pip python3-venv libxml-parser-perl libjson-perl curl \
          jq tree bc automake autoconf libtool pkg-config ca-certificates \
          ca-bundle

    - name: 配置构建缓存
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          build_dir
          staging_dir
        key: ${{ runner.os }}-${{ runner.os_version }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.os_version }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-
          ${{ runner.os }}-${{ runner.os_version }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-
          ${{ runner.os }}-${{ runner.os_version }}-openwrt-${{ github.event.inputs.source_branch }}-

    - name: 设置ccache缓存
      run: |
        echo "配置ccache缓存大小..."
        ccache -M 10G
        ccache -s

    - name: 生成OpenWrt构建配置
      run: |
        cat << EOF > .config
        # 指定目标架构和设备型号
        CONFIG_TARGET_${TARGET_ARCH}_${DEVICE_MODEL}=y
        # 启用ccache以加速构建
        CONFIG_CCACHE=y
        # 使用24.10推荐的无线网络包
        CONFIG_PACKAGE_wpad=y
        # 确保启用必要的内核模块
        CONFIG_PACKAGE_kmod-usb-core=y
        CONFIG_PACKAGE_kmod-usb-storage=y
        # 提升USB2.0存储性能
        CONFIG_PACKAGE_block-mount=y
        # 可选：USB网络共享支持
        CONFIG_PACKAGE_kmod-usb-net=y
        CONFIG_PACKAGE_kmod-usb-net-asix=y
        EOF
        
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"; for app in "${APPS[@]}"; do
            echo "CONFIG_PACKAGE_$app=y" >> .config
          done
        fi
        
        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.include_packages }}"; for pkg in "${PKGS[@]}"; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
          done
        fi

    - name: 验证构建配置
      run: |
        echo "## 验证 .config 文件"
        cat .config
        echo "## 检查关键配置项"
        grep -E "CONFIG_TARGET_${TARGET_ARCH}_${DEVICE_MODEL}|CONFIG_CCACHE" .config || exit 1

    - name: 执行固件构建
      id: build_firmware
      run: |
        set -e
        BUILD_START=$(date +%s)
        echo "::group::开始构建 OpenWrt 固件"
        make -j$(nproc) BUILD_LOG=1 ${{ github.event.inputs.verbose_build == 'true' && 'V=s' || '' }}
        echo "::endgroup::"
        DURATION=$(( $(date +%s) - BUILD_START ))
        echo "build_duration=$DURATION" >> $GITHUB_OUTPUT
        echo "build_exit_code=$?" >> $GITHUB_OUTPUT
        echo "build_status=$( [ $? -eq 0 ] && echo success || echo failed )" >> $GITHUB_OUTPUT

    - name: 监控构建资源使用
      if: always()
      run: |
        echo "## 详细资源使用情况"
        ccache -s
        echo "## 内存使用详情"
        free -h
        echo "## CPU使用详情"
        top -b -n 1 -o %CPU | head -20
        echo "## 磁盘使用情况"
        df -h

    - name: 收集失败构建日志
      if: failure()
      run: |
        echo "构建失败，收集详细错误信息..."
        grep -i -E "error:|fatal:|failed:|undefined reference" build_dir/**/log.* | head -50
        echo "内核日志:"
        dmesg | tail -500
        echo "已安装包列表:"
        opkg list-installed > installed-packages.txt
        cat installed-packages.txt
        echo "构建配置:"
        cat .config

    - name: 上传构建产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-$TARGET_ARCH-$DEVICE_MODEL
        path: |
          bin/targets/${TARGET_ARCH}/**/*
          bin/targets/${TARGET_ARCH}/packages/*
        retention-days: 7

    - name: 创建GitHub Release
      if: ${{ github.event.inputs.create_release && success() }}
      uses: ncipollo/release-action@v2
      with:
        tag: ${{ github.event.inputs.source_branch }}-${{ env.TARGET_ARCH }}-${{ env.DEVICE_MODEL }}-${{ steps.repo_info.outputs.sha }}
        name: OpenWrt $TARGET_ARCH/$DEVICE_MODEL Build #${{ github.run_number }}
        body: |
          Build Info
          - Architecture: $TARGET_ARCH
          - Device Model: $DEVICE_MODEL
          - Source Branch: ${{ github.event.inputs.source_branch }}
          - Duration: ${{ steps.build_firmware.outputs.build_duration }}s
          - Date: ${{ replace(steps.repo_info.outputs.commit_message, '\n', ' ') }}
          - Commit: ${{ steps.repo_info.outputs.sha }} (${{ steps.repo_info.outputs.branch }})
          - Author: ${{ steps.repo_info.outputs.author }}

          Included Packages
          - LuCI Apps: ${{ github.event.inputs.include_luci_apps }}
          - Custom Packages: ${{ github.event.inputs.include_packages }}

          Build Environment
          - Runner OS: ${{ runner.os }}
          - Jobs: $(nproc)
        artifacts: |
          bin/targets/${TARGET_ARCH}/**/*
          bin/targets/${TARGET_ARCH}/packages/*
        draft: false
        prerelease: false
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
