name: OpenWrt Free Firmware

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: 'è®¾å¤‡æž¶æž„'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: 'è®¾å¤‡åž‹å·'
        required: true
        default: 'an7581'
        type: string
      packages:
        description: 'è½¯ä»¶åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule,tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: 'å‘å¸ƒåˆ° GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: 'å¯ç”¨è¯¦ç»†æž„å»ºè¾“å‡º'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: /tmp/ccache
  BUILD_LOG_DIR: build_logs
  JOBS: $(nproc)

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
    
    steps:
    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "RELEASE_TAG=build-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

    - name: æ£€å‡ºæºç 
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: é…ç½®ä¼˜åŒ–çš„ Feeds
      run: |
        # é‡å†™ feeds.conf.defaultï¼Œå®˜æ–¹æºä¼˜å…ˆ
        cat > feeds.conf.default << 'EOF'
# å®˜æ–¹æ ¸å¿ƒä»“åº“ - æœ€é«˜ä¼˜å…ˆçº§
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git

# ç¬¬ä¸‰æ–¹è¡¥å……ä»“åº“ - æŒ‰ç¨³å®šæ€§æŽ’åº
src-git coolsnowwolf https://github.com/coolsnowwolf/packages
src-git coolsnowwolf_luci https://github.com/coolsnowwolf/luci
src-git kenzo https://github.com/kenzok8/openwrt-packages
src-git small https://github.com/kenzok8/small
src-git lienol https://github.com/Lienol/openwrt-package
EOF
        echo "âœ… Feeds é…ç½®å®Œæˆ - å®˜æ–¹ä»“åº“ä¼˜å…ˆçº§æœ€é«˜"

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-setuptools rsync unzip zlib1g-dev file wget

    - name: é…ç½®ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ hashFiles('feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-

    - name: è®¾ç½®æž„å»ºçŽ¯å¢ƒ
      run: |
        ccache -M 5G
        ./scripts/feeds update -a
        
        # éªŒè¯å…³é”®åŒ…çš„æ¥æº
        echo "ðŸ” éªŒè¯å…³é”®åŒ…æ¥æº:"
        for pkg in luci-base luci-mod-admin-full luci-theme-bootstrap dnsmasq firewall; do
          if ./scripts/feeds list | grep -q " $pkg "; then
            source=$(./scripts/feeds list | grep " $pkg " | head -1 | awk '{print $2}')
            echo "ðŸ“¦ $pkg æ¥è‡ª: $source"
          fi
        done
        
        ./scripts/feeds install -a

    - name: ç”Ÿæˆé…ç½®
      run: |
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y" > .config
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        
        # ç¡®ä¿ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬çš„å…³é”®åŒ…
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        
        if [ -n "${{ github.event.inputs.packages }}" ]; then
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.packages }}"
          for pkg in "${PKGS[@]}"; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        
        make defconfig

    - name: ä¸‹è½½ä¾èµ–
      run: make download -j$JOBS

    - name: æž„å»ºå›ºä»¶
      run: |
        mkdir -p $BUILD_LOG_DIR
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          make V=s -j$JOBS 2>&1 | tee $BUILD_LOG_DIR/build.log
        else
          make -j$JOBS 2>&1 | tee $BUILD_LOG_DIR/build.log
        fi

    - name: ä¸Šä¼ äº§ç‰©
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: openwrt-${{ env.BUILD_DATE }}
        path: bin/targets/
        retention-days: 7

    - name: åˆ›å»ºå‘å¸ƒ
      if: github.event.inputs.create_release == 'true' && success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: OpenWrt ${{ env.BUILD_DATE }}
        body: |
          æž¶æž„: ${{ github.event.inputs.target_arch }}
          åž‹å·: ${{ github.event.inputs.device_model }}
          åˆ†æ”¯: ${{ github.event.inputs.source_branch }}
          Feeds ä¼˜å…ˆçº§: å®˜æ–¹ â†’ coolsnowwolf â†’ kenzo â†’ lienol
        files: bin/targets/**/*.bin

    - name: å¤±è´¥è¯Šæ–­
      if: failure()
      run: |
        echo "æž„å»ºå¤±è´¥:"
        tail -200 $BUILD_LOG_DIR/build.log 2>/dev/null || echo "æ— æ—¥å¿—"