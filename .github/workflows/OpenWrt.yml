name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCI应用（逗号分隔）'
        required: false
        default: 'luci-app-upnp,luci-app-firewall,luci-app-wireguard'
        type: string
      create_release:
        description: '发布到GitHub Release'
        required: false
        default: true
        type: boolean
      verbose_build:
        description: '启用详细构建输出'
        required: false
        default: false
        type: boolean
      custom_feeds:
        description: '自定义feeds URL（每行一个，格式: name>url）'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip \
          python3-setuptools rsync unzip wget zlib1g-dev file time ccache \
          python3-dev python3-wheel python3-venv

    - name: Validate Inputs
      run: |
        # 验证输入参数格式
        if ! [[ "${{ github.event.inputs.target_arch }}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
          echo "❌ 设备架构包含无效字符"
          exit 1
        fi
        if ! [[ "${{ github.event.inputs.device_model }}" =~ ^[a-zA-Z0-9_-]+$ ]]; then
          echo "❌ 设备型号包含无效字符"
          exit 1
        fi

    - name: Cache Build Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          build_dir
          staging_dir
          logs
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-
          ${{ runner.os }}-openwrt-

    - name: Add Custom Feeds
      if: ${{ github.event.inputs.custom_feeds != '' }}
      run: |
        if [ -n "${{ github.event.inputs.custom_feeds }}" ]; then
          echo "处理自定义 feeds..."
          # 直接处理多行输入
          echo "${{ github.event.inputs.custom_feeds }}" | while IFS= read -r line; do
            line_trimmed=$(echo "$line" | xargs)
            if [ -n "$line_trimmed" ] && [[ $line_trimmed == *">"* ]]; then
              echo "添加: $line_trimmed"
              echo "$line_trimmed" >> feeds.conf.default
            fi
          done
          echo "当前 feeds.conf.default:"
          cat feeds.conf.default
        fi

    - name: Update and Install Feeds
      run: |
        ./scripts/feeds update -a || exit 1
        ./scripts/feeds install -a || exit 1

    - name: Configure LuCI Components
      id: configure_luci
      run: |
        # 安装 LuCI 核心包
        CORE_PACKAGES=(
          "luci" "luci-base" "luci-compat" 
          "luci-lib-base" "luci-lib-ip" 
          "luci-lib-jsonc" "luci-lib-nixio"
        )
        
        for pkg in "${CORE_PACKAGES[@]}"; do
          ./scripts/feeds install "$pkg" || true
        done
        
        # 安装主题
        ./scripts/feeds install luci-theme-bootstrap || true
        ./scripts/feeds install luci-theme-argon || true
        
        # 安装用户指定的 LuCI 应用
        APPS_COUNT=0
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            app_trimmed=$(echo "$app" | xargs)
            if [ -n "$app_trimmed" ]; then
              if ./scripts/feeds install "$app_trimmed"; then
                ((APPS_COUNT++))
              fi
            fi
          done
        fi
        
        echo "luci_apps_count=${APPS_COUNT}" >> $GITHUB_OUTPUT

    - name: Configure Build
      run: |
        # 将输入参数转换为大写
        TARGET_ARCH_UPPER=$(echo "${{ github.event.inputs.target_arch }}" | tr '[:lower:]' '[:upper:]')
        DEVICE_MODEL_UPPER=$(echo "${{ github.event.inputs.device_model }}" | tr '[:lower:]' '[:upper:]')
        
        # 配置生成
        cat > .config << EOF
CONFIG_TARGET_${TARGET_ARCH_UPPER}=y
CONFIG_TARGET_${TARGET_ARCH_UPPER}_${DEVICE_MODEL_UPPER}=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-lib-base=y
CONFIG_PACKAGE_luci-lib-ip=y
CONFIG_PACKAGE_luci-lib-jsonc=y
CONFIG_PACKAGE_luci-lib-nixio=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_tcpdump=y
CONFIG_CCACHE=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-theme-argon=y
EOF
        
        # 安装 LuCI 应用
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            app_trimmed=$(echo "$app" | xargs)
            if [ -n "$app_trimmed" ]; then
              echo "CONFIG_PACKAGE_${app_trimmed}=y" >> .config
            fi
          done
        fi
        
        make defconfig

    - name: Customize LuCI Configuration
      run: |
        mkdir -p files/etc/uci-defaults
        
        cat > files/etc/uci-defaults/99_luci-theme << 'EOF'
#!/bin/sh
[ -f /etc/config/luci ] || exit 0
uci -q batch << EOI
set luci.main.mediaurlbase='/luci-static/argon'
commit luci
EOI
exit 0
EOF
        
        chmod +x files/etc/uci-defaults/99_luci-theme

    - name: Build Firmware
      id: build
      continue-on-error: true
      run: |
        export CCACHE_DIR="${{ github.workspace }}/.ccache"
        export CCACHE_MAXSIZE=2G
        export CCACHE_COMPRESS=1
        mkdir -p "$CCACHE_DIR"
        
        mkdir -p build-logs
        
        BUILD_START_TIME=$(date +%s)
        
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          make -j$(nproc) V=s 2>&1 | tee build-logs/build.log
        else
          make -j$(nproc) 2>&1 | tee build-logs/build.log
        fi
        
        BUILD_EXIT_CODE=$?
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "build_status=success" >> $GITHUB_OUTPUT
          echo "build_duration=${BUILD_DURATION}" >> $GITHUB_OUTPUT
        else
          echo "build_status=failure" >> $GITHUB_OUTPUT
          echo "build_duration=${BUILD_DURATION}" >> $GITHUB_OUTPUT
          exit $BUILD_EXIT_CODE
        fi

    - name: Verify Build Output
      if: steps.build.outputs.build_status == 'success'
      run: |
        if [ ! -d "bin/targets" ]; then
          echo "❌ bin/targets 目录不存在"
          exit 1
        fi
        
        # 使用兼容性更好的固件文件查找方式
        FIRMWARE_FILES=$(find bin/targets -type f -size +1M | grep -E '\.(bin|img|tar|gz|trx|elf|ubi|ubifs|squashfs|ext4)$' || true)
        FIRMWARE_COUNT=$(echo "$FIRMWARE_FILES" | grep -c . || true)
        
        if [ $FIRMWARE_COUNT -eq 0 ]; then
          echo "❌ 未找到任何固件文件（大于1MB）"
          echo "找到的文件："
          find bin/targets -type f | head -20
          exit 1
        fi
        
        echo "✅ 找到 $FIRMWARE_COUNT 个固件文件"
        echo "$FIRMWARE_FILES" | head -10

    - name: Collect Error Logs
      if: ${{ steps.build.outputs.build_status == 'failure' }}
      run: |
        mkdir -p error-logs
        if [ -d "build-logs" ]; then
          cp -r build-logs/ error-logs/ 2>/dev/null || true
        fi
        # 收集关键配置文件用于调试
        cp .config error-logs/ 2>/dev/null || true
        cp feeds.conf.default error-logs/ 2>/dev/null || true

    - name: Upload Error Logs
      if: ${{ steps.build.outputs.build_status == 'failure' }}
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_id }}
        path: error-logs/
        retention-days: 7

    - name: Upload Artifacts
      if: steps.build.outputs.build_status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}
        path: bin/targets/
        retention-days: 7

    - name: Create Release
      if: ${{ github.event.inputs.create_release && steps.build.outputs.build_status == 'success' }}
      uses: ncipollo/release-action@v1
      with:
        tag: openwrt-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-${{ github.run_number }}-${{ github.run_attempt }}
        name: OpenWrt ${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}
        body: |
          构建信息:
          - 源码分支: ${{ github.event.inputs.source_branch }}
          - 设备架构: ${{ github.event.inputs.target_arch }}
          - 设备型号: ${{ github.event.inputs.device_model }}
          - LuCI应用: ${{ github.event.inputs.include_luci_apps }}
          - 构建耗时: ${{ steps.build.outputs.build_duration }} 秒
        artifacts: "bin/targets/**/*"
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
