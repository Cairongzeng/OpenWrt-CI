name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号'
        required: true
        default: 'an7581'
        type: string
      create_release:
        description: '发布到GitHub Release'
        required: false
        default: true
        type: boolean
      verbose_build:
        description: '启用详细构建输出'
        required: false
        default: false
        type: boolean
      custom_feeds:
        description: '自定义feeds URL (每行一个，格式: name>url)'
        required: false
        default: ''
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev libelf-dev python3 python3-pip \
          python3-setuptools rsync unzip wget zlib1g-dev file time ccache subversion quilt

    - name: Add Custom Feeds
      if: ${{ github.event.inputs.custom_feeds != '' }}
      run: |
        echo "添加自定义 feeds..."
        # 将用户输入的 feeds 添加到 feeds.conf.default
        echo "${{ github.event.inputs.custom_feeds }}" | while IFS= read -r line; do
          if [ -n "$line" ]; then
            echo "添加: $line"
            echo "$line" >> feeds.conf.default
          fi
        done
        echo "当前 feeds.conf.default 内容:"
        cat feeds.conf.default

    - name: Configure Build
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y" > .config
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y" >> .config
        make defconfig

    - name: Build Firmware
      id: build
      continue-on-error: true
      run: |
        export CCACHE_DIR="$(pwd)/.ccache"
        mkdir -p build-logs
        
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          echo "使用详细输出模式构建"
          make -j$(nproc) V=s 2>&1 | tee build-logs/build.log
        else
          echo "使用静默模式构建"
          make -j$(nproc) 2>&1 | tee build-logs/build.log
        fi
        
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "build_status=success" >> $GITHUB_OUTPUT
        else
          echo "build_status=failure" >> $GITHUB_OUTPUT
          echo "=== 错误摘要 ==="
          grep -i -E "error:|failed|undefined" build-logs/build.log | head -20
        fi

    - name: Collect Error Logs
      if: ${{ steps.build.outputs.build_status == 'failure' }}
      run: |
        mkdir -p error-logs
        cp build-logs/build.log error-logs/ 2>/dev/null || true
        
        # 创建错误摘要
        echo "构建错误摘要" > error-logs/summary.txt
        echo "分支: ${{ github.event.inputs.source_branch }}" >> error-logs/summary.txt
        echo "架构: ${{ github.event.inputs.target_arch }}" >> error-logs/summary.txt
        echo "型号: ${{ github.event.inputs.device_model }}" >> error-logs/summary.txt
        echo "" >> error-logs/summary.txt
        
        if [ -f "build-logs/build.log" ]; then
          grep -A 2 -B 1 -i -E "error:|failed|undefined" build-logs/build.log | head -30 >> error-logs/summary.txt
        fi

    - name: Upload Error Logs
      if: ${{ steps.build.outputs.build_status == 'failure' }}
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_id }}
        path: error-logs/
        retention-days: 30

    - name: Generate Release Tag
      if: ${{ github.event.inputs.create_release && steps.build.outputs.build_status == 'success' }}
      id: tag
      run: |
        echo "tag_name=openwrt-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-${{ github.run_id }}" >> $GITHUB_OUTPUT

    - name: Upload Artifacts
      if: steps.build.outputs.build_status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}
        path: bin/targets/
        retention-days: 7

    - name: Create Release
      if: ${{ github.event.inputs.create_release && steps.build.outputs.build_status == 'success' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: OpenWrt ${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}
        body: |
          OpenWrt 自动构建
          
          构建信息:
          - 源码分支: ${{ github.event.inputs.source_branch }}
          - 设备架构: ${{ github.event.inputs.target_arch }}
          - 设备型号: ${{ github.event.inputs.device_model }}
          - 构建时间: ${{ fromJSON(format('"{0}"', github.workflow_run.created_at)) }}
          - 自定义 Feeds: ${{ github.event.inputs.custom_feeds != '' && '是' || '否' }}
        files: bin/targets/**/*

    - name: Build Failed
      if: steps.build.outputs.build_status == 'failure'
      run: |
        echo "构建失败，不会创建 Release"
        exit 1
