name: OpenWrt Build

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支（如 main, openwrt-24.10）'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构（如 airoha, x86_64）'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号（如 an7581）'
        required: true
        default: 'an7581'
        type: string
      include_luci_apps:
        description: 'LuCI 应用（逗号分隔，如 luci-app-adblock）'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule'
        type: string
      include_packages:
        description: '功能包列表（非 LuCI，逗号分隔）'
        required: false
        default: 'tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: '发布到 GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: '启用详细构建输出（V=s）'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: /tmp/ccache
  BUILD_LOG_DIR: build_logs

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      TARGET_ARCH: ${{ github.event.inputs.target_arch }}
      DEVICE_MODEL: ${{ github.event.inputs.device_model }}

    steps:
    - name: 检出OpenWrt源代码
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: 获取仓库元数据
      id: repo_info
      run: |
        echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "branch=$(git branch --show-current || echo 'detached')" >> $GITHUB_OUTPUT
        echo "tag=$(git describe --tags --abbrev=0 2>/dev/null || echo 'none')" >> $GITHUB_OUTPUT
        echo "commit_message=$(git log -1 --pretty=%B | head -n1)" >> $GITHUB_OUTPUT
        echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: 安装构建依赖
      run: |
        sudo apt-get update -q
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential ccache ecj fastjar file g++ gawk \
          getgit libelf-dev libncurses5-dev libncursesw5-dev \
          libssl-dev python3 unzip wget \
          python3-setuptools rsync subversion swig time xsltproc \
          zlib1g-dev clang flex bison gcc-multilib python3-pip \
          python3-venv libxml-parser-perl libjson-perl curl jq \
          tree bc automake autoconf libtool pkg-config ca-certificates

    - name: 配置构建缓存
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          build_dir
          staging_dir
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-${{ hashFiles('feeds.conf', '.config', 'package/feeds/*/*/Makefile') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}-

    - name: 初始化 feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成基础配置
      run: |
        # 生成默认配置
        make defconfig
        
        # 应用自定义配置
        cat << EOF >> .config
        CONFIG_TARGET_${TARGET_ARCH}=y
        CONFIG_TARGET_${TARGET_ARCH}_${DEVICE_MODEL}=y
        CONFIG_CCACHE=y
        CONFIG_BUILD_LOG=y
        EOF

    - name: 配置软件包
      run: |
        # 清理配置中的注释和空行
        sed -i '/^#/d' .config
        sed -i '/^$/d' .config
        
        # 添加 LuCI 应用
        if [ -n "${{ github.event.inputs.include_luci_apps }}" ]; then
          IFS=',' read -ra APPS <<< "${{ github.event.inputs.include_luci_apps }}"
          for app in "${APPS[@]}"; do
            echo "CONFIG_PACKAGE_${app}=y" >> .config
          done
        fi
        
        # 添加功能包
        if [ -n "${{ github.event.inputs.include_packages }}" ]; then
          IFS=',' read -ra PKGS <<< "${{ github.event.inputs.include_packages }}"
          for pkg in "${PKGS[@]}"; do
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          done
        fi
        
        # 最终验证配置
        make defconfig

    - name: 显示构建配置摘要
      run: |
        echo "## 构建配置摘要"
        echo "目标架构: $TARGET_ARCH"
        echo "设备型号: $DEVICE_MODEL"
        echo "源码分支: ${{ github.event.inputs.source_branch }}"
        echo "包含的 LuCI 应用: ${{ github.event.inputs.include_luci_apps }}"
        echo "包含的功能包: ${{ github.event.inputs.include_packages }}"
        echo ""
        echo "## 关键配置项"
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE" .config | head -20

    - name: 执行固件构建
      id: build_firmware
      run: |
        set -e
        BUILD_START=$(date +%s)
        
        echo "::group::开始构建 OpenWrt 固件"
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        else
          make -j$(($(nproc) + 1)) 2>&1 | tee build.log
        fi
        echo "::endgroup::"
        
        BUILD_END=$(date +%s)
        DURATION=$((BUILD_END - BUILD_START))
        echo "build_duration=$DURATION" >> $GITHUB_OUTPUT
        echo "build_status=success" >> $GITHUB_OUTPUT

    - name: 收集构建信息
      if: success()
      run: |
        echo "## 构建完成信息"
        echo "构建时长: ${{ steps.build_firmware.outputs.build_duration }} 秒"
        echo "构建时间: $(date)"
        
        # 显示生成的固件文件
        echo "## 生成的固件文件"
        find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.gz" | sort
        
        # 显示文件大小
        echo "## 文件大小"
        find bin/targets -type f -name "*sysupgrade*" -exec ls -lh {} \;
        
        # ccache 统计
        echo "## CCache 统计"
        ccache -s

    - name: 上传构建日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-$TARGET_ARCH-$DEVICE_MODEL
        path: |
          build.log
          logs/
        retention-days: 3

    - name: 上传构建产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-$TARGET_ARCH-$DEVICE_MODEL
        path: |
          bin/targets/$TARGET_ARCH/**/*
        retention-days: 7
        compression-level: 0

    - name: 创建GitHub Release
      if: ${{ github.event.inputs.create_release && success() }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.repo_info.outputs.date }}-${{ steps.repo_info.outputs.sha }}
        name: "OpenWrt $TARGET_ARCH/$DEVICE_MODEL Build"
        body: |
          ## 构建信息
          
          **设备信息**
          - 架构: $TARGET_ARCH
          - 型号: $DEVICE_MODEL
          
          **源码信息**  
          - 分支: ${{ github.event.inputs.source_branch }}
          - 提交: ${{ steps.repo_info.outputs.sha }}
          - 作者: ${{ steps.repo_info.outputs.author }}
          - 时间: ${{ steps.repo_info.outputs.date }}
          
          **构建配置**
          - 构建时长: ${{ steps.build_firmware.outputs.build_duration }}秒
          - LuCI应用: ${{ github.event.inputs.include_luci_apps }}
          - 功能包: ${{ github.event.inputs.include_packages }}
          
          **包含文件**
          - 系统固件
          - 软件包索引
          - 配置文件
        files: |
          bin/targets/$TARGET_ARCH/**/openwrt-*
          bin/targets/$TARGET_ARCH/**/packages/*
        draft: false
        prerelease: false