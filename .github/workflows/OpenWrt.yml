name: OpenWrt Free Firmware

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: '源码分支'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '设备架构'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号'
        required: true
        default: 'an7581'
        type: string
      packages:
        description: '软件列表（逗号分隔）'
        required: false
        default: 'luci-mod-admin-full,luci-theme-bootstrap,luci-app-statistics,luci-app-upnp,luci-app-firewall,luci-app-wireguard,luci-app-wifi-schedule,tailscale,iperf3,tcpdump,curl,wget,htop,nano'
        type: string
      create_release:
        description: '发布到 GitHub Release'
        required: false
        default: false
        type: boolean
      verbose_build:
        description: '启用详细构建输出'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: /tmp/ccache
  JOBS: $(nproc)

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
    
    steps:
    - name: 检出源码并初始化
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: 配置环境和依赖
      run: |
        # 设置构建信息
        echo "BUILD_DATE=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "RELEASE_TAG=build-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        
        # 配置 feeds
        cat >> feeds.conf.default << 'EOF'
src-git coolsnowwolf https://github.com/coolsnowwolf/packages
src-git coolsnowwolf_luci https://github.com/coolsnowwolf/luci
src-git kenzo https://github.com/kenzok8/openwrt-packages
src-git small https://github.com/kenzok8/small
src-git lienol https://github.com/Lienol/openwrt-package
EOF

        # 安装依赖
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3-setuptools rsync unzip zlib1g-dev file wget

    - name: 配置缓存
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: 准备构建环境
      run: |
        ccache -M 5G
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 配置和构建
      run: |
        # 生成配置
        {
          echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y"
          echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y"
          echo "CONFIG_CCACHE=y"
          
          if [ -n "${{ github.event.inputs.packages }}" ]; then
            IFS=',' read -ra PKGS <<< "${{ github.event.inputs.packages }}"
            for pkg in "${PKGS[@]}"; do
              echo "CONFIG_PACKAGE_${pkg}=y"
            done
          fi
        } > .config
        
        make defconfig
        make download -j$JOBS
        
        # 构建固件
        if [ "${{ github.event.inputs.verbose_build }}" = "true" ]; then
          make V=s -j$JOBS
        else
          make -j$JOBS
        fi

    - name: 上传构建产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-${{ env.BUILD_DATE }}
        path: bin/targets/
        retention-days: 7

    - name: 创建发布
      if: github.event.inputs.create_release == 'true' && success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: OpenWrt ${{ env.BUILD_DATE }}
        body: |
          架构: ${{ github.event.inputs.target_arch }}
          型号: ${{ github.event.inputs.device_model }}
          分支: ${{ github.event.inputs.source_branch }}
        files: bin/targets/**/*.bin