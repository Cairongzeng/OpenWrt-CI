name: OpenWrt Builder

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'OpenWrt 源码分支'
        required: true
        default: 'openwrt-24.10'
        type: string
      target_arch:
        description: '目标架构'
        required: true
        default: 'airoha'
        type: string
      device_model:
        description: '设备型号'
        required: true
        default: 'an7581'
        type: string
      packages:
        description: '预装软件包列表'
        required: false
        default: 'luci,luci-ssl,luci-theme-bootstrap,luci-i18n-base-zh-cn,luci-theme-argon,luci-app-ddns,luci-app-printer,luci-app-ramfree,luci-app-diskman,luci-app-appfilter,luci-app-tailscale,tailscale,tailscaled,ddns-scripts,p910nd,usbutils,parted,e2fsprogs'
        type: string
      create_release:
        description: '发布到 GitHub Release'
        required: false
        default: false
        type: boolean

env:
  CCACHE_DIR: /tmp/ccache

jobs:
  build-firmware:
    name: 构建固件 ${{ github.event.inputs.target_arch }}/${{ github.event.inputs.device_model }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: write
    
    steps:
    - name: 初始化环境
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "RELEASE_TAG=build-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV

    - name: 检出源码
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive

    - name: 配置软件源
      run: |
        echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential clang flex bison g++ gawk gcc-multilib gettext git \
          libncurses5-dev libssl-dev python3-setuptools rsync unzip zlib1g-dev \
          file wget ccache zip

    - name: 配置缓存
      uses: actions/cache@v4
      with:
        path: |
          /tmp/ccache
          dl
        key: ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ github.event.inputs.source_branch }}

    - name: 准备环境
      run: |
        ccache -M 5G
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成基础配置
      run: |
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}=y" > .config
        echo "CONFIG_TARGET_${{ github.event.inputs.target_arch }}_${{ github.event.inputs.device_model }}=y" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        make defconfig

    - name: 检查默认包配置
      run: |
        echo "官方默认包配置检查"
        echo "目标设备: ${{ github.event.inputs.target_arch }}/${{ github.event.inputs.device_model }}"
        
        ERROR_COUNT=0
        
        check_package() {
          if grep -q "^CONFIG_PACKAGE_$1=y" .config; then
            echo "通过: $1"
            return 0
          else
            echo "错误: 缺失必需包 $1"
            return 1
          fi
        }
        
        echo ""
        echo "核心系统包检查:"
        check_package "base-files" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "busybox" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "procd" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "ubox" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "ubus" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "uci" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "netifd" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "firewall" || ERROR_COUNT=$((ERROR_COUNT+1))
        
        echo ""
        echo "网络服务包检查:"
        check_package "dnsmasq" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "dropbear" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "odhcpd" || ERROR_COUNT=$((ERROR_COUNT+1))
        
        echo ""
        echo "包管理检查:"
        check_package "opkg" || ERROR_COUNT=$((ERROR_COUNT+1))
        check_package "ca-bundle" || ERROR_COUNT=$((ERROR_COUNT+1))
        
        echo ""
        echo "内核模块统计:"
        grep "^CONFIG_PACKAGE_kmod-" .config | wc -l | xargs echo "内核模块数量:"
        
        echo ""
        if [ $ERROR_COUNT -gt 0 ]; then
          echo "构建失败: 发现 $ERROR_COUNT 个必需包缺失"
          echo "正在自动修复缺失包..."
          # 自动添加缺失的必需包
          if ! grep -q "^CONFIG_PACKAGE_firewall=y" .config; then
            echo "CONFIG_PACKAGE_firewall=y" >> .config
            echo "已添加: firewall"
          fi
          if ! grep -q "^CONFIG_PACKAGE_odhcpd=y" .config; then
            echo "CONFIG_PACKAGE_odhcpd=y" >> .config
            echo "已添加: odhcpd"
          fi
          echo "重新生成配置..."
          make defconfig
        else
          echo "检查通过: 所有必需包都存在"
        fi

    - name: 添加用户包配置
      run: |
        PACKAGES="${{ github.event.inputs.packages }}"
        PACKAGES=$(echo "$PACKAGES" | sed 's/，/,/g')
        
        if [ -n "$PACKAGES" ]; then
          echo "添加用户自定义包: $PACKAGES"
          echo "$PACKAGES" | tr ',' '\n' | while read pkg; do
            pkg_clean=$(echo "$pkg" | tr -d ' ')
            if [ -n "$pkg_clean" ]; then
              echo "CONFIG_PACKAGE_${pkg_clean}=y" >> .config
            fi
          done
        fi
        
        make defconfig

    - name: 下载源码
      run: |
        for i in {1..3}; do
          if make download -j$(nproc); then
            break
          else
            [ $i -eq 3 ] && exit 1
            sleep 10
          fi
        done

    - name: 编译固件
      run: |
        mkdir -p build_logs
        make -j$(nproc) 2>&1 | tee build_logs/build.log || {
          grep -i "error\|warn\|missing\|depends" build_logs/build.log | head -20
          exit 1
        }

    - name: 检查输出
      run: |
        find bin/ -type f -name "*.bin" -o -name "*.img" -o -name "*.gz" | head -20
        ls -la bin/ || echo "bin目录不存在"

    - name: 打包产物
      run: |
        zip -r "openwrt-build-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-${{ env.BUILD_DATE }}.zip" . \
          -x "*.git*" "dl/*" "tmp/*" "build_dir/*" "staging_dir/*" "build_logs/*" "*.log" "logs/*" ".config.old"

    - name: 上传产物
      uses: actions/upload-artifact@v4
      if: success() || failure()
      with:
        name: openwrt-${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }}-${{ env.BUILD_DATE }}
        path: openwrt-build-*.zip
        retention-days: 7

    - name: 创建发布
      if: github.event.inputs.create_release == 'true' && success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: OpenWrt ${{ github.event.inputs.target_arch }}-${{ github.event.inputs.device_model }} ${{ env.BUILD_DATE }}
        body: |
          源码分支: ${{ github.event.inputs.source_branch }}
          目标架构: ${{ github.event.inputs.target_arch }}
          设备型号: ${{ github.event.inputs.device_model }}
          预装软件: ${{ github.event.inputs.packages }}
        files: openwrt-build-*.zip