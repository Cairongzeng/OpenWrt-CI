name: OpenWrt 构建工作流

on:
  workflow_dispatch:
    inputs:
      include_chinese:
        description: '包含中文语言支持（默认不勾选）'
        required: false
        default: false
        type: boolean
      create_release:
        description: '创建GitHub发布版本'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v3

      - name: 设置构建环境
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev gawk git libssl-dev wget unzip

      - name: 初始化OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 安装中文语言支持
        if: ${{ github.event.inputs.include_chinese == 'true' }}
        run: |
          cd openwrt
          ./scripts/feeds install luci-i18n-base-zh-cn
          ./scripts/feeds install luci-theme-argon
          ./scripts/feeds install luci-app-adguardhome

      - name: 生成构建配置 (.config)
        run: |
          cd openwrt
          # 基础配置
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_DEVEL=y" >> .config
          
          # 网络配置
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-firewall=y" >> .config
          
          # 中文支持配置
          if [ "${{ github.event.inputs.include_chinese }}" = "true" ]; then
            ./scripts/feeds search luci-i18n-base-zh-cn | grep -q luci-i18n-base-zh-cn && echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
            echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config
            echo "CONFIG_PACKAGE_luci-app-adguardhome=y" >> .config
          fi
          
          # 保存配置
          make defconfig

      - name: 构建OpenWrt
        run: |
          cd openwrt
          make -j$(nproc)

      - name: 上传构件
        uses: actions/upload-artifact@v3
        with:
          name: openwrt-build
          path: openwrt/bin/targets/x86/64/

      - name: 创建GitHub发布版本
        if: ${{ github.event.inputs.create_release == 'true' && success() }}
        uses: ncipollo/release-action@v2
        with:
          tag: ${{ github.ref }}
          name: OpenWrt 构建版本 ${{ github.ref }}
          body: |
            # OpenWrt 构建发布
            
            ## 构建信息
            - **构建日期**: ${{ github.run_id }}
            - **提交**: ${{ github.sha }}
            - **目标平台**: x86_64
            
            ## 功能特性
            - **Web界面**: LuCI
            - **中文支持**: ${{ github.event.inputs.include_chinese == 'true' && '已启用' || '未启用' }}
            - **包含组件**:
              - 基础: LuCI, 防火墙
              - ${ github.event.inputs.include_chinese == 'true' && '- 中文: 基础语言包, Argon主题, AdGuardHome' || '' }
            
            ## 使用方法
            1. 下载适合的镜像文件
            2. 刷写到设备
            3. 通过 http://192.168.1.1 访问
